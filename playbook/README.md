# Домашнее задание к занятию 3 «Использование Ansible»

**1) Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.**
**2) При создании tasks рекомендую использовать модули: get_url, template, yum, apt.**
**3) Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг для открытия LightHouse, запустить веб-сервер.**
- В плейбуке `site.yml` добавил `tasks` для установки и запуска веб-сервера Nginx, установки и настройки Lighthouse.  
```
- name: Install nginx
  hosts: lighthouse
  handlers:
    - name: start-nginx
      service:
        name: nginx
        state: started
        enabled: yes
    - name: reload-nginx
      service:
        name: nginx
        state: reloaded
  tasks:
    - name: NGINX | Install epel-release
      ansible.builtin.yum:
        name: epel-release
        state: latest
    - name: NGINX | Install NGINX
      ansible.builtin.yum:
        name: nginx
        state: present
      notify: start-nginx

- name: Install lighthouse
  hosts: lighthouse
  pre_tasks:
    - name: Lighthouse | install dependencies
      ansible.builtin.yum:
        name:
          - git
          - java-11-openjdk
        state: present
  tasks:
    - name: clean nginx workdir
      shell: rm -rf {{ lighthouse_location_dir }}/*
    - name: Lighthouse | Copy from git
      git:
        repo: "{{ lighthouse_vcs }}"
        version: master
        dest: "{{ lighthouse_location_dir }}"
        force: true
```
**4) Подготовьте свой inventory-файл prod.yml**
```
clickhouse:
  hosts:
    clickhouse-01:
      ansible_host: "84.201.185.114"
      ansible_user: "admin"
lighthouse:
  hosts:
    lighthouse-01:
      ansible_host: "84.201.185.96"
      ansible_user: admin
      ansible_become: true
      lighthouse_vcs: https://github.com/VKCOM/lighthouse.git
      lighthouse_location_dir: /usr/share/nginx/html
vector:
  hosts:
    vector-01:
      ansible_host: "51.250.121.76"
      ansible_user: admin
      ansible_become: yes
      vector_version: "0.34.1-1"
      test: "this is my test"
```
**5) Запустите ansible-lint site.yml и исправьте ошибки, если они есть.**
**6) Попробуйте запустить playbook на этом окружении с флагом --check.**
```
user@test-VM:~/module_ansible/mnt-homeworks/08-ansible-02-playbook/playbook$ 
ansible-playbook -i inventory/prod.yml site.yml --check

PLAY [Install nginx] **************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
The authenticity of host '84.201.185.96 (84.201.185.96)' can't be established.
ECDSA key fingerprint is SHA256:WORJvQSQjkZG/gsma25m6J4i9MxzcSKFjDaLntSCcRc.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [lighthouse-01]

TASK [NGINX | Install epel-release] ***********************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [NGINX | Install NGINX] ******************************************************************************************************************************************************************************
ok: [lighthouse-01]

PLAY [Install lighthouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [Lighthouse | install dependencies] ******************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [clean nginx workdir] ********************************************************************************************************************************************************************************
skipping: [lighthouse-01]

TASK [Lighthouse | Copy from git] *************************************************************************************************************************************************************************
ok: [lighthouse-01]

PLAY [Install Clickhouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
The authenticity of host '84.201.185.114 (84.201.185.114)' can't be established.
ECDSA key fingerprint is SHA256:wsrre6o9R1p0NJGW1kPQ9f8Bn7mD3YJkZyvzd7iSuoo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [clickhouse-01]

TASK [Get clickhouse distrib] *****************************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
ok: [clickhouse-01] => (item=clickhouse-common-static)

TASK [Install clickhouse packages] ************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Flush handlers] *************************************************************************************************************************************************************************************

TASK [Create database] ************************************************************************************************************************************************************************************
skipping: [clickhouse-01]

PLAY [Install Vector] *************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
The authenticity of host '51.250.121.76 (51.250.121.76)' can't be established.
ECDSA key fingerprint is SHA256:d3hFuJJ6ij6taKfV6T49En5XAP/Ojc/q4hcMfPY6R3g.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
ok: [vector-01]

TASK [Get vector distrib] *********************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Install vector packages] ****************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Deploy config vector] *******************************************************************************************************************************************************************************
ok: [vector-01]

PLAY RECAP ************************************************************************************************************************************************************************************************
clickhouse-01              : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
lighthouse-01              : ok=6    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
vector-01                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
**7) Запустите playbook на prod.yml окружении с флагом --diff. Убедитесь, что изменения на системе произведены.**
```
user@test-VM:~/module_ansible/mnt-homeworks/08-ansible-02-playbook/playbook$ 
ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install nginx] **************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [NGINX | Install epel-release] ***********************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [NGINX | Install NGINX] ******************************************************************************************************************************************************************************
ok: [lighthouse-01]

PLAY [Install lighthouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [Lighthouse | install dependencies] ******************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [clean nginx workdir] ********************************************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [Lighthouse | Copy from git] *************************************************************************************************************************************************************************
changed: [lighthouse-01]

PLAY [Install Clickhouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] *****************************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
ok: [clickhouse-01] => (item=clickhouse-common-static)

TASK [Install clickhouse packages] ************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Flush handlers] *************************************************************************************************************************************************************************************

TASK [Create database] ************************************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install Vector] *************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Get vector distrib] *********************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Install vector packages] ****************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Deploy config vector] *******************************************************************************************************************************************************************************
ok: [vector-01]

PLAY RECAP ************************************************************************************************************************************************************************************************
clickhouse-01              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
lighthouse-01              : ok=7    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector-01                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```
**8) Повторно запустите playbook с флагом --diff и убедитесь, что playbook идемпотентен.**
```
user@test-VM:~/module_ansible/mnt-homeworks/08-ansible-02-playbook/playbook$ ansible-playbook -i inventory/prod.yml site.yml --diff

PLAY [Install nginx] **************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [NGINX | Install epel-release] ***********************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [NGINX | Install NGINX] ******************************************************************************************************************************************************************************
ok: [lighthouse-01]

PLAY [Install lighthouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [Lighthouse | install dependencies] ******************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [clean nginx workdir] ********************************************************************************************************************************************************************************
changed: [lighthouse-01]

TASK [Lighthouse | Copy from git] *************************************************************************************************************************************************************************
changed: [lighthouse-01]

PLAY [Install Clickhouse] *********************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] *****************************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
ok: [clickhouse-01] => (item=clickhouse-common-static)

TASK [Install clickhouse packages] ************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Flush handlers] *************************************************************************************************************************************************************************************

TASK [Create database] ************************************************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install Vector] *************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Get vector distrib] *********************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Install vector packages] ****************************************************************************************************************************************************************************
ok: [vector-01]

TASK [Deploy config vector] *******************************************************************************************************************************************************************************
ok: [vector-01]

PLAY RECAP ************************************************************************************************************************************************************************************************
clickhouse-01              : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
lighthouse-01              : ok=7    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
vector-01                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
**9) Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.**

**При создании конфигурации nginx и lighthouse произведено:**
- дополнен `inventory` файл группой хостов `lighthouse` с параметрами: 
  ansible_host: "84.201.185.96"
  ansible_user: admin
  ansible_become: true
  lighthouse_vcs: https://github.com/VKCOM/lighthouse.git
  lighthouse_location_dir: /usr/share/nginx/html
- создан playbook `Install nginx`, который запускается на хостах группы `lighthouse`, описанных в `inventory`;
  в playbook созданы:  
  - обработчик `handler` с модулем `service` для запуска и перезапуска сервиса nginx; 
  - task `NGINX | Install epel-release` с использованием модуля `yum` происходит установка пакета `epel-release`;
  - task `NGINX | Install NGINX` с использованием модуля `yum` устанавливает веб-сервер nginx версии `latest`;
- создан playbook `Install lighthouse`, который запускается на хостах группы `lighthouse`;
  в playbook созданы: 
  - pre-tasks `Lighthouse | install dependencies` с использованием модуля `yum` происходит установка пакетов `git` и `java-11-openjdk`;
  - task `clean nginx workdir` с использованием shell-команды `rm -rf` для удаления всех файлов из директории;
  - task `Lighthouse | Copy from git` с использованием модуля `git`, с помощью которого происходит скачивание репозитория по заданному пути; 

**При создании конфигурации vector произведено:**
- создан `inventory` с группой `vector`, содержащей параметры:
  ansible_host: "51.250.121.136"
  ansible_user: admin
  ansible_become: yes
  vector_version: "0.34.1-1"
  test: "this is my test" 
- создан playbook `install vector`, который запускается на hosts группы `vector`, описанных в `inventory`;
  в playbook созданы: 
  - обработчик `handler` с модулем `service` для перезапуска сервиса vector в случае внесения изменений; 
  - task `Get vector distrib` с использованием модуля `get_url` происходит скачивание rpm-пакета в текущую директорию;
  - task `Install vector packages` с использованием модуля `yum` устанавливает данный rpm-пакет;
  - task `Deploy config vector` с использованием модуля `template` отправляет шаблон по пути `/etc/vector/vector.yaml`;
  - notify вызывает `handlers`.

**10) Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-03-yandex` на фиксирующий коммит, в ответ предоставьте ссылку на него.**



